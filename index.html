<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CloudStream-like Web Player (Firebase)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  :root{--bg:#0f1115;--card:#14161a;--accent:#e50914;--muted:#9aa0a6;color-scheme: dark}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:#fff}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 20px;background:linear-gradient(90deg,#0b0c0e, #111)}
  header h1{font-size:18px;margin:0}
  main{display:grid;grid-template-columns:360px 1fr;gap:18px;padding:18px}
  /* Left sidebar */
  .sidebar{background:var(--card);border-radius:10px;padding:12px;min-height:80vh}
  .section{margin-bottom:12px}
  input[type="text"], input[type="url"]{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);background:#0d0d0d;color:#fff}
  button{background:var(--accent);border:0;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
  .repo-list{max-height:220px;overflow:auto;margin-top:8px}
  .repo-item{display:flex;justify-content:space-between;padding:8px;border-radius:6px;background:#0b0b0b;margin-bottom:6px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  /* Center content */
  .content{display:flex;flex-direction:column;gap:12px}
  .player-card{background:var(--card);padding:12px;border-radius:10px}
  video{width:100%;height:460px;background:#000;border-radius:8px;outline:1px solid rgba(255,255,255,0.02)}
  .controls-row{display:flex;align-items:center;gap:8px;margin-top:8px}
  .search-bar{display:flex;gap:8px}
  .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
  .tile{background:#0d0d0d;padding:8px;border-radius:8px;overflow:hidden}
  .tile img{width:100%;height:120px;object-fit:cover;border-radius:6px}
  .tile h3{font-size:15px;margin:8px 0 4px}
  .tile p{font-size:13px;color:var(--muted);height:34px;overflow:hidden}
  .tile .actions{display:flex;gap:6px;margin-top:8px}
  .badge{display:inline-block;padding:4px 6px;background:#111;border-radius:6px;font-size:12px;color:var(--muted)}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
  .flex{display:flex;gap:8px;align-items:center}
  .danger{background:#a33}
  .muted-btn{background:#222;color:var(--muted);border-radius:8px;padding:6px 8px}
  .small-link{font-size:13px;color:var(--muted);text-decoration:underline;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>CloudStream-like Player</h1>
  <div class="flex">
    <div class="small muted-btn" id="user-status">Not signed in</div>
    <button id="sign-out" style="display:none;background:#333">Sign out</button>
  </div>
</header>

<main>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="section">
      <h3>Add Repository</h3>
      <div class="small">Enter a JSON endpoint that returns an array of media items</div>
      <input id="repo-url" type="url" placeholder="https://example.com/repo.json" />
      <div style="display:flex;gap:6px;margin-top:8px">
        <button id="add-repo">Add Repo</button>
        <button id="add-sample" class="muted-btn">Add Sample Repo</button>
      </div>
    </div>

    <div class="section">
      <h3>Repositories</h3>
      <div class="repo-list" id="repo-list"></div>
    </div>

    <div class="section">
      <h3>Saved & History</h3>
      <div style="display:flex;gap:6px">
        <button id="view-saved" class="muted-btn">Saved</button>
        <button id="view-history" class="muted-btn">History</button>
      </div>
      <div id="saved-history-list" style="margin-top:8px;max-height:220px;overflow:auto"></div>
    </div>

    <div class="section small">
      <strong>Repo JSON format</strong><br/>
      Each repo should return an array of items: <code>[{title,description,poster,sources:[{label,url,subtitles:[{lang,label,vtt}]}]}]</code>
      <div style="margin-top:8px;color:var(--muted)">Only add sources you have rights to. This app does not index websites or scrape content.</div>
    </div>
  </aside>

  <!-- Content -->
  <section class="content">
    <div class="player-card">
      <video id="video-player" controls crossorigin="anonymous" preload="metadata"></video>

      <div class="controls-row">
        <div class="search-bar" style="flex:1">
          <input id="global-search" type="text" placeholder="Search title / description across repos..." />
          <button id="search-btn">Search</button>
        </div>

        <div class="flex">
          <select id="audio-select"><option value="">Audio tracks</option></select>
          <select id="subtitle-select"><option value="">Subtitles</option></select>
          <button id="save-link" class="muted-btn">Save</button>
        </div>
      </div>

    </div>

    <div id="results-area">
      <div class="results" id="results"></div>
    </div>

  </section>
</main>

<footer>
  Built for personal use. Use only legal sources. Firebase: saves repos, saved links, history.
</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

<script>
/* ============================
   Firebase config - your project
   (Using the project you provided earlier)
   ============================ */
const firebaseConfig = {
  apiKey: "AIzaSyDin-ueMfhRwZ7EOWrpYRbyhTcvtm-xZ6s",
  authDomain: "dias-aea74.firebaseapp.com",
  projectId: "dias-aea74",
  storageBucket: "dias-aea74.firebasestorage.app",
  messagingSenderId: "261547908584",
  appId: "1:261547908584:web:809d448f6b35a1b0f7985d",
  measurementId: "G-WQ2ZXZX0VV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
firebase.auth().signInAnonymously().catch(console.error);

/* ===============
   App state
   =============== */
const repoListEl = document.getElementById('repo-list');
const resultsEl = document.getElementById('results');
const savedHistoryList = document.getElementById('saved-history-list');
const player = document.getElementById('video-player');
const addRepoBtn = document.getElementById('add-repo');
const addSampleBtn = document.getElementById('add-sample');
const repoUrlInput = document.getElementById('repo-url');
const globalSearch = document.getElementById('global-search');
const searchBtn = document.getElementById('search-btn');
const saveLinkBtn = document.getElementById('save-link');
const audioSelect = document.getElementById('audio-select');
const subtitleSelect = document.getElementById('subtitle-select');
const viewSavedBtn = document.getElementById('view-saved');
const viewHistoryBtn = document.getElementById('view-history');
const userStatus = document.getElementById('user-status');
const signOutBtn = document.getElementById('sign-out');

let localRepos = [];   // array of {id, url, title}
let index = [];        // global index of media items
let savedLinks = [];   // from Firestore
let history = JSON.parse(localStorage.getItem('cs_history')||'[]');
let currentItem = null;

/* ===============
   Utility / UI
   =============== */
function uid(len=8){ return Math.random().toString(36).slice(2,2+len); }
function show(msg){ alert(msg); }

function renderRepos(){
  repoListEl.innerHTML = '';
  if(localRepos.length===0){ repoListEl.innerHTML = '<div class="small">No repos. Add one.</div>'; return; }
  localRepos.forEach((r, idx) => {
    const el = document.createElement('div');
    el.className = 'repo-item';
    el.innerHTML = `<div>
                      <div style="font-weight:600">${r.title || r.url}</div>
                      <div class="small">${r.url}</div>
                    </div>
                    <div style="display:flex;gap:6px">
                      <button class="muted-btn" data-idx="${idx}" onclick="fetchRepoIndex(${idx})">Refresh</button>
                      <button class="muted-btn" data-idx="${idx}" onclick="removeRepo(${idx})">Remove</button>
                    </div>`;
    repoListEl.appendChild(el);
  });
}

function renderResults(list){
  resultsEl.innerHTML = '';
  if(!list || list.length===0){ resultsEl.innerHTML = '<div class="small">No results</div>'; return; }
  list.forEach(item => {
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.innerHTML = `
      <img src="${item.poster || ''}" onerror="this.style.opacity=.5;this.style.objectFit='contain'"/>
      <h3>${item.title}</h3>
      <p>${item.description || ''}</p>
      <div class="actions">
        ${item.sources && item.sources.length ? item.sources.map((s, i) =>
          `<button onclick='playSource(${JSON.stringify(escapeQuotes(item.title))}, ${JSON.stringify(i)}, ${JSON.stringify(item)})'>Play: ${s.label||'source '+(i+1)}</button>`).join('') : '<span class="badge">No sources</span>'}
        <button class="muted-btn" onclick='saveItem(${JSON.stringify(item.title)}, ${JSON.stringify(item)})'>Save</button>
      </div>
    `;
    resultsEl.appendChild(tile);
  });
}

// helper to avoid breaking quotes when embedding JSON in onclick
function escapeQuotes(s){ return String(s).replaceAll("'", "\\'").replaceAll('"', '\\"'); }

/* ===============
   Repo handling
   =============== */
async function loadSavedReposFromFirestore(){
  try{
    const snap = await db.collection('repos').get();
    localRepos = snap.docs.map(d => ({id: d.id, ...d.data()}));
    renderRepos();
    // fetch each repo's index
    await Promise.all(localRepos.map((_,i)=>fetchRepoIndex(i).catch(()=>{})));
  }catch(e){
    // no repos yet or offline
    console.log('loadSavedRepos', e);
  }
}

async function addRepo(url){
  // Basic validation: must be http/https
  if(!url || !/^https?:\/\//i.test(url)) return show('Enter a valid https URL');
  // Try fetch and validate JSON
  try{
    const r = await fetch(url, {cache:'no-cache'});
    if(!r.ok) throw new Error('Fetch failed: '+r.status);
    const data = await r.json();
    if(!Array.isArray(data)) throw new Error('Repo JSON must be an array of items');
    const title = (data && data[0] && data[0].title) ? (data[0].title + '...') : url;
    // Save to Firestore
    const doc = await db.collection('repos').add({url, title, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
    localRepos.push({id: doc.id, url, title});
    renderRepos();
    // Immediately index
    await fetchRepoIndex(localRepos.length-1);
    show('Repo added and indexed');
  }catch(e){
    console.error(e);
    show('Failed to add repo: ' + (e.message || e));
  }
}

async function fetchRepoIndex(idx){
  const repo = localRepos[idx];
  if(!repo) return;
  try{
    const res = await fetch(repo.url, {cache:'no-cache'});
    if(!res.ok) throw new Error('Fetch failed');
    const arr = await res.json();
    if(!Array.isArray(arr)) throw new Error('Repo returned non-array JSON');
    // Attach repo meta
    arr.forEach(item => item._repo = {url: repo.url, id: repo.id});
    // merge into global index (dedupe by title+url)
    const merged = [];
    const keySet = new Set();
    index = index.filter(it => it._repo && it._repo.id !== repo.id); // remove old items from this repo
    index = index.concat(arr);
    renderResults(index.slice(0,50));
  }catch(e){
    console.error('fetchRepoIndex', e);
    show('Failed to fetch repo index: ' + (e.message || e));
  }
}

async function removeRepo(idx){
  const repo = localRepos[idx];
  if(!repo) return;
  if(!confirm('Remove repository?')) return;
  try{
    if(repo.id) await db.collection('repos').doc(repo.id).delete();
  }catch(e){
    console.warn('Failed delete from firestore', e);
  }
  localRepos.splice(idx,1);
  renderRepos();
  // remove items from index
  index = index.filter(it => !(it._repo && it._repo.id === repo.id));
  renderResults(index.slice(0,50));
}

/* ===============
   Search
   =============== */
searchBtn.onclick = async () => {
  const q = (globalSearch.value || '').trim().toLowerCase();
  if(!q){ renderResults(index.slice(0,60)); return; }
  const res = index.filter(it => (it.title && it.title.toLowerCase().includes(q)) ||
                                   (it.description && it.description.toLowerCase().includes(q)));
  renderResults(res.slice(0,200));
};

/* ===============
   Playback & tracks
   =============== */
function clearTracks(){
  audioSelect.innerHTML = '<option value="">Audio tracks</option>';
  subtitleSelect.innerHTML = '<option value="">Subtitles</option>';
  // remove existing <track> elements
  const tracks = player.querySelectorAll('track');
  tracks.forEach(t => t.remove());
}

function populateTracks(){
  // audioTracks API (not supported in all browsers)
  audioSelect.innerHTML = '<option value="">Audio tracks</option>';
  if(player.audioTracks && player.audioTracks.length){
    for(let i=0;i<player.audioTracks.length;i++){
      const t = player.audioTracks[i];
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = t.label || ('Track ' + (i+1));
      audioSelect.appendChild(opt);
    }
  }
  // textTracks
  subtitleSelect.innerHTML = '<option value="">Subtitles</option>';
  const tks = player.textTracks;
  for(let i=0;i<tks.length;i++){
    const t = tks[i];
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = t.label || t.language || ('Subtitle '+(i+1));
    subtitleSelect.appendChild(opt);
  }
  // wire events
  audioSelect.onchange = () => {
    if(player.audioTracks) for(let i=0;i<player.audioTracks.length;i++) player.audioTracks[i].enabled = (i==audioSelect.value);
  };
  subtitleSelect.onchange = () => {
    for(let i=0;i<player.textTracks.length;i++) player.textTracks[i].mode = (i==subtitleSelect.value)?'showing':'disabled';
  };
}

function playSource(title, sourceIndex, itemObj){
  // itemObj may be stringified earlier; ensure it's parsed if needed
  const item = (typeof itemObj === 'string') ? JSON.parse(itemObj) : itemObj;
  if(!item || !item.sources || !item.sources[sourceIndex]) return show('Source not found');
  const source = item.sources[sourceIndex];

  // set current item
  currentItem = { title: item.title, source };

  // clear tracks then set src and add subtitle tracks if present
  clearTracks();
  player.src = source.url;
  player.load();

  // add subtitle <track> tags (if present)
  if(Array.isArray(source.subtitles)){
    source.subtitles.forEach((sub, i) => {
      const t = document.createElement('track');
      t.kind = 'subtitles';
      t.label = sub.label || sub.lang || ('sub'+(i+1));
      t.srclang = sub.lang || '';
      t.src = sub.vtt;
      t.mode = 'disabled';
      player.appendChild(t);
    });
  }
  // attempt to unmute + play (user interaction required by browser)
  player.muted = false;
  player.volume = 1;
  player.play().catch(e => {
    // If autoplay prevented, user will click play - that's fine.
    console.log('play prevented', e);
  });

  // update history
  history = history.filter(h=>h.url !== source.url);
  history.push({title: item.title, url: source.url, date: new Date().toISOString()});
  localStorage.setItem('cs_history', JSON.stringify(history));
  renderSavedHistory(); // update sidebar saved/history display
}

/* Helper wrapper used when rendering tiles to pass JSON safely */
window.playSource = function(title, sourceIndex, itemObj){
  // itemObj may be object literal embedded as string in onclick; handle if stringified
  let item = itemObj;
  try{ if(typeof itemObj === 'string' && itemObj.trim().startsWith('{')) item = JSON.parse(itemObj); }catch(e){}
  playSource(title, sourceIndex, item);
};

/* ===============
   Save & Delete items
   =============== */
async function saveItem(title, item){
  if(!item || !item.sources || !item.sources.length) return show('Nothing to save');
  const first = item.sources[0];
  try{
    await db.collection('savedLinks').add({title:item.title,url:first.url,meta:item,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    show('Saved to cloud');
    await loadSavedLinksFromFirestore();
  }catch(e){
    console.error(e);
    show('Failed saving: '+e.message);
  }
}

async function loadSavedLinksFromFirestore(){
  try{
    const snap = await db.collection('savedLinks').get();
    savedLinks = snap.docs.map(d => ({id:d.id, ...d.data()}));
    renderSavedHistory();
  }catch(e){ console.error(e); }
}

async function deleteSavedLink(id){
  if(!confirm('Delete saved link?')) return;
  try{ await db.collection('savedLinks').doc(id).delete(); await loadSavedLinksFromFirestore(); }catch(e){console.error(e);}
}

/* ===============
   Saved / History sidebar
   =============== */
function renderSavedHistory(){
  savedHistoryList.innerHTML = '';
  // history (local)
  if(history && history.length){
    const hsection = document.createElement('div');
    hsection.innerHTML = '<div style="font-weight:700;margin-bottom:6px">History</div>';
    history.slice().reverse().forEach((h,i)=>{
      const el = document.createElement('div');
      el.className = 'small';
      el.style.display='flex'; el.style.justifyContent='space-between'; el.style.marginBottom='6px';
      el.innerHTML = `<div style="flex:1">${h.title || h.url}</div>
                      <div style="display:flex;gap:6px">
                        <button class="muted-btn" onclick="playSavedHistory('${encodeURIComponent(h.url)}')">▶</button>
                        <button class="muted-btn" onclick="removeHistoryItem(${history.length-1-i})">🗑</button>
                      </div>`;
      hsection.appendChild(el);
    });
    savedHistoryList.appendChild(hsection);
  }
  // saved links (cloud)
  if(savedLinks && savedLinks.length){
    const ssection = document.createElement('div');
    ssection.innerHTML = '<div style="font-weight:700;margin-top:10px;margin-bottom:6px">Saved</div>';
    savedLinks.forEach(s=>{
      const el = document.createElement('div');
      el.style.display='flex'; el.style.justifyContent='space-between'; el.style.marginBottom='6px';
      el.innerHTML = `<div style="flex:1">${s.title||s.url}</div>
                      <div style="display:flex;gap:6px">
                        <button class="muted-btn" onclick="playSavedCloud('${encodeURIComponent(s.url)}')">▶</button>
                        <button class="muted-btn" onclick="deleteSavedLink('${s.id}')">🗑</button>
                      </div>`;
      ssection.appendChild(el);
    });
    savedHistoryList.appendChild(ssection);
  }
}

window.playSavedHistory = function(encUrl){
  const url = decodeURIComponent(encUrl);
  player.src = url; player.play().catch(()=>{});
};
window.playSavedCloud = function(encUrl){
  const url = decodeURIComponent(encUrl);
  player.src = url; player.play().catch(()=>{});
};
window.removeHistoryItem = function(idx){
  history.splice(idx,1);
  localStorage.setItem('cs_history', JSON.stringify(history));
  renderSavedHistory();
};

/* ===============
   Sign-in tracker & startup
   =============== */
firebase.auth().onAuthStateChanged(user => {
  if(user){
    userStatus.textContent = 'Signed in (anon)';
    signOutBtn.style.display = 'inline-block';
    // load cloud data
    loadSavedReposFromFirestore();
    loadSavedLinksFromFirestore();
  } else {
    userStatus.textContent = 'Not signed in';
    signOutBtn.style.display = 'none';
  }
});

signOutBtn.onclick = () => {
  firebase.auth().signOut();
  location.reload();
};

/* ===============
   Small sample repo (public domain video) to demonstrate functionality
   =============== */
const sampleRepo = [
  {
    "id": "bbb",
    "title": "Big Buck Bunny (sample)",
    "description": "Demo public-domain clip - Big Buck Bunny",
    "poster": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/images/BigBuckBunny.jpg",
    "sources": [
      {
        "label": "MP4 360p",
        "url": "https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4",
        "subtitles": []
      }
    ]
  }
];

addSampleBtn.onclick = async () => {
  // Save the sample repo to Firestore so it appears in repo list
  try{
    const doc = await db.collection('repos').add({url:'__sample__', title:'Sample Repo (Big Buck Bunny)', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
    localRepos.push({id: doc.id, url:'__sample__', title:'Sample Repo (Big Buck Bunny)'});
    // store sample items in a separate collection named by repo id (local indexing)
    // For simplicity, we will just merge into index client-side
    index = index.concat(sampleRepo.map(it => ({...it, _repo:{id:doc.id,url:'__sample__'}})));
    renderRepos(); renderResults(index.slice(0,50));
    show('Sample repo added (local index).');
  }catch(e){
    console.error(e); show('Failed adding sample repo: '+e.message);
  }
};

/* ===============
   Initialization: load repos/saved/history
   =============== */
(async function init(){
  // load repos from Firestore (if any)
  try{ await loadSavedReposFromFirestore(); }catch(e){console.warn(e)}
  // load saved links
  try{ await loadSavedLinksFromFirestore(); }catch(e){}
  // render index initial (empty)
  renderResults(index.slice(0,50));
  renderSavedHistory();
})();

/* Expose small functions to global scope for onclick handlers */
window.saveItem = function(title, item){
  // item may be object; if not, ignore
  try{
    const obj = (typeof item === 'string' && item.trim().startsWith('{')) ? JSON.parse(item) : item;
    saveItem(title, obj);
  }catch(e){ console.error(e); }
};
</script>
</body>
</html>
